{% extends "base/layout.html" %}
{% load static %}
{% block title %}Two-Factor Authentication Enabled - InvoiceFlow{% endblock %}
{% block meta_description %}Your account is now protected with two-factor authentication.{% endblock %}
{% block body_class %}auth-page{% endblock %}
{% block nav %}{% endblock %}
{% block footer %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="auth-background">
        <div class="auth-gradient-orb auth-gradient-orb-1"></div>
        <div class="auth-gradient-orb auth-gradient-orb-2"></div>
        <div class="auth-gradient-orb auth-gradient-orb-3"></div>
        <div class="auth-grid-overlay"></div>
    </div>

    <div class="auth-mfa-container auth-mfa-complete">
        <div class="auth-card auth-card-mfa-complete" role="region" aria-labelledby="mfa-complete-title">
            <header class="auth-card-header">
                <div class="auth-success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <h2 id="mfa-complete-title" class="auth-card-title">2FA Enabled Successfully</h2>
                <p class="auth-card-subtitle">Your account is now protected with two-factor authentication</p>
            </header>

            <div class="auth-recovery-section">
                <h3 class="auth-recovery-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    Recovery Codes
                </h3>
                
                <div class="auth-alert auth-alert-warning" role="alert">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <div>
                        <strong>Save these codes now!</strong>
                        <p>You can use these codes to access your account if you lose your authenticator device. Each code can only be used once.</p>
                    </div>
                </div>
                
                <div class="auth-recovery-codes" role="list" aria-label="Recovery codes">
                    {% for code in recovery_codes %}
                        <div class="auth-recovery-code" role="listitem">{{ code }}</div>
                    {% endfor %}
                </div>
                
                <div class="auth-recovery-actions">
                    <button type="button" class="auth-action-btn" id="downloadBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <span>Download</span>
                    </button>
                    <button type="button" class="auth-action-btn" id="copyBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                        <span>Copy All</span>
                    </button>
                    <button type="button" class="auth-action-btn" id="printBtn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <polyline points="6 9 6 2 18 2 18 9"/>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                            <rect x="6" y="14" width="12" height="8"/>
                        </svg>
                        <span>Print</span>
                    </button>
                </div>
            </div>

            <div class="auth-checkbox-group">
                <label class="auth-checkbox" id="confirmCheckbox">
                    <input type="checkbox" id="codesConfirmed" required>
                    <span class="auth-checkbox-mark" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </span>
                    <span class="auth-checkbox-label">I have saved my recovery codes in a secure location</span>
                </label>
            </div>

            <a href="{% url 'dashboard' %}" class="auth-submit-btn" id="continueBtn">
                <span class="auth-submit-text">Continue to Dashboard</span>
                <svg class="auth-submit-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <line x1="5" y1="12" x2="19" y2="12"/>
                    <polyline points="12 5 19 12 12 19"/>
                </svg>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    const recoveryCodes = [{% for code in recovery_codes %}"{{ code }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    const continueBtn = document.getElementById('continueBtn');
    const confirmCheckbox = document.getElementById('codesConfirmed');
    
    continueBtn.style.opacity = '0.5';
    continueBtn.style.pointerEvents = 'none';
    
    confirmCheckbox.addEventListener('change', function() {
        if (this.checked) {
            continueBtn.style.opacity = '1';
            continueBtn.style.pointerEvents = 'auto';
        } else {
            continueBtn.style.opacity = '0.5';
            continueBtn.style.pointerEvents = 'none';
        }
    });
    
    document.getElementById('downloadBtn').addEventListener('click', function() {
        const content = "InvoiceFlow Recovery Codes\n" +
                       "==========================\n\n" +
                       "Generated: " + new Date().toISOString().split('T')[0] + "\n\n" +
                       "Keep these codes safe. Each code can only be used once.\n" +
                       "Store them in a password manager or print and keep in a secure location.\n\n" +
                       recoveryCodes.join("\n");
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'invoiceflow-recovery-codes.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.querySelector('span').textContent = 'Downloaded!';
        setTimeout(() => {
            this.querySelector('span').textContent = 'Download';
        }, 2000);
    });
    
    document.getElementById('copyBtn').addEventListener('click', function() {
        const btn = this;
        const codesText = recoveryCodes.join('\n');
        navigator.clipboard.writeText(codesText).then(() => {
            btn.querySelector('span').textContent = 'Copied!';
            btn.classList.add('is-success');
            setTimeout(() => {
                btn.querySelector('span').textContent = 'Copy All';
                btn.classList.remove('is-success');
            }, 2000);
        });
    });
    
    document.getElementById('printBtn').addEventListener('click', function() {
        const printWindow = window.open('', '_blank');
        const printContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>InvoiceFlow Recovery Codes</title>
                <style>
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; max-width: 600px; margin: 0 auto; }
                    h1 { font-size: 24px; margin-bottom: 8px; }
                    p { color: #666; margin-bottom: 24px; }
                    .codes { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
                    .code { font-family: 'SF Mono', Monaco, monospace; font-size: 16px; background: #f5f5f5; padding: 12px; border-radius: 8px; text-align: center; }
                    .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
                    .date { color: #999; font-size: 14px; margin-top: 24px; }
                </style>
            </head>
            <body>
                <h1>InvoiceFlow Recovery Codes</h1>
                <div class="warning">
                    <strong>Important:</strong> Keep these codes in a safe place. Each code can only be used once to access your account if you lose your authenticator device.
                </div>
                <div class="codes">
                    ${recoveryCodes.map(code => `<div class="code">${code}</div>`).join('')}
                </div>
                <p class="date">Generated: ${new Date().toLocaleDateString()}</p>
            </body>
            </html>
        `;
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
    });
});
</script>
{% endblock %}
