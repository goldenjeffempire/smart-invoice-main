{% extends "base/layout.html" %}
{% load static %}
{% block title %}Analytics{% endblock %}
{% block body_class %}dashboard-light-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard-light.css' %}">
{% endblock %}

{% block nav %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<div class="dashboard-light">
    {% include 'components/sidebar-light.html' with active='analytics' %}
    
    <main class="dashboard-light-main">
        <header class="dashboard-light-header">
            <div class="dashboard-light-header-content">
                <h1>Analytics</h1>
                <p>Track your business performance and revenue insights</p>
            </div>
        </header>
        
        <div class="stats-light-grid">
            <div class="stat-light-card stat-revenue">
                <div class="stat-light-header">
                    <div class="stat-light-icon icon-success">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    {% if revenue_growth > 0 %}
                    <div class="stat-light-trend trend-up">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                        </svg>
                        +{{ revenue_growth|floatformat:1 }}%
                    </div>
                    {% elif revenue_growth < 0 %}
                    <div class="stat-light-trend trend-down">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
                        </svg>
                        {{ revenue_growth|floatformat:1 }}%
                    </div>
                    {% endif %}
                </div>
                <div class="stat-light-value">${{ total_revenue|floatformat:2|default:"0.00" }}</div>
                <div class="stat-light-label">Total Revenue</div>
            </div>
            
            <div class="stat-light-card stat-invoices">
                <div class="stat-light-header">
                    <div class="stat-light-icon icon-primary">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-light-value">{{ total_invoices|default:0 }}</div>
                <div class="stat-light-label">Total Invoices</div>
            </div>
            
            <div class="stat-light-card stat-paid">
                <div class="stat-light-header">
                    <div class="stat-light-icon icon-info">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-light-value">{{ paid_invoices|default:0 }}</div>
                <div class="stat-light-label">Paid Invoices</div>
            </div>
            
            <div class="stat-light-card stat-pending">
                <div class="stat-light-header">
                    <div class="stat-light-icon icon-warning">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                </div>
                <div class="stat-light-value">${{ pending_amount|floatformat:2|default:"0.00" }}</div>
                <div class="stat-light-label">Pending Amount</div>
            </div>
        </div>
        
        <div class="dashboard-light-grid">
            <div class="card-light">
                <div class="card-light-header">
                    <h2 class="card-light-title">Revenue Over Time</h2>
                    <span style="font-size: 0.875rem; color: var(--light-text-tertiary);">Last 12 months</span>
                </div>
                <div class="card-light-body">
                    <div class="chart-light-container" style="height: 350px;">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card-light">
                <div class="card-light-header">
                    <h2 class="card-light-title">Invoice Status</h2>
                </div>
                <div class="card-light-body">
                    <div class="chart-light-container" style="height: 350px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-light" style="margin-top: 24px;">
            <div class="card-light-header">
                <h2 class="card-light-title">Top Clients</h2>
                <span style="font-size: 0.875rem; color: var(--light-text-tertiary);">By total revenue</span>
            </div>
            {% if top_clients %}
            <div style="overflow-x: auto;">
                <table class="table-light">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Invoices</th>
                            <th>Total Revenue</th>
                            <th>Avg Invoice</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for client in top_clients %}
                        <tr>
                            <td style="font-weight: 600;">{{ client.name }}</td>
                            <td>{{ client.invoice_count }}</td>
                            <td>${{ client.total_revenue|floatformat:2 }}</td>
                            <td>${{ client.avg_invoice|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="card-light-body">
                <div class="empty-light-state" style="padding: 32px;">
                    <p style="color: var(--light-text-tertiary); margin: 0;">No client data available yet</p>
                </div>
            </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.getElementById('mobile-toggle');
    const sidebar = document.getElementById('dashboard-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (mobileToggle) {
        mobileToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });
    }
    
    if (overlay) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });
    }
    
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
        const revenueData = {{ revenue_chart_data|safe|default:'{"labels": [], "data": []}' }};
        
        new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: revenueData.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Revenue',
                    data: revenueData.data || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                    backgroundColor: 'rgba(99, 102, 241, 0.8)',
                    borderColor: '#6366f1',
                    borderWidth: 0,
                    borderRadius: 6,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#0f172a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                return '$' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#64748b',
                            font: { size: 12 }
                        }
                    },
                    y: {
                        grid: {
                            color: '#e2e8f0'
                        },
                        ticks: {
                            color: '#64748b',
                            font: { size: 12 },
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Paid', 'Unpaid', 'Overdue'],
                datasets: [{
                    data: [{{ paid_invoices|default:0 }}, {{ unpaid_invoices|default:0 }}, {{ overdue_invoices|default:0 }}],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0,
                    spacing: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            font: { size: 14 }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
