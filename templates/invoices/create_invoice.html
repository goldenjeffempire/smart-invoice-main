{% extends "base/layout.html" %}
{% load static %}
{% block title %}Create Invoice{% endblock %}
{% block body_class %}dashboard-light-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard-light.css' %}">
<style>
.form-light-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.form-light-grid-3 {
    grid-template-columns: repeat(3, 1fr);
}

@media (max-width: 768px) {
    .form-light-grid,
    .form-light-grid-3 {
        grid-template-columns: 1fr;
    }
}

.form-light-group.full-width {
    grid-column: 1 / -1;
}

.section-light {
    background: var(--light-bg-secondary);
    border-radius: var(--light-radius-xl);
    border: 1px solid var(--light-border-primary);
    padding: 24px;
    margin-bottom: 24px;
}

.section-light-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--light-border-primary);
}

.section-light-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--light-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
}

.section-light-icon svg {
    width: 24px;
    height: 24px;
}

.section-light-icon.icon-business {
    background: var(--light-primary-light);
}

.section-light-icon.icon-business svg {
    stroke: var(--light-primary);
}

.section-light-icon.icon-client {
    background: var(--light-success-light);
}

.section-light-icon.icon-client svg {
    stroke: var(--light-success);
}

.section-light-icon.icon-invoice {
    background: var(--light-accent-light);
}

.section-light-icon.icon-invoice svg {
    stroke: var(--light-accent);
}

.section-light-icon.icon-items {
    background: var(--light-warning-light);
}

.section-light-icon.icon-items svg {
    stroke: var(--light-warning);
}

.section-light-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--light-text-primary);
    margin: 0;
}

.form-light-sections {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
    margin-bottom: 24px;
}

@media (max-width: 1024px) {
    .form-light-sections {
        grid-template-columns: 1fr;
    }
}

.line-items-light {
    margin-top: 16px;
}

.line-items-light-header {
    display: grid;
    grid-template-columns: 2fr 80px 120px 120px 48px;
    gap: 12px;
    padding: 12px 16px;
    background: var(--light-bg-tertiary);
    border-radius: var(--light-radius-lg) var(--light-radius-lg) 0 0;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--light-text-tertiary);
}

@media (max-width: 768px) {
    .line-items-light-header {
        display: none;
    }
}

.line-item-light {
    display: grid;
    grid-template-columns: 2fr 80px 120px 120px 48px;
    gap: 12px;
    padding: 16px;
    background: var(--light-bg-secondary);
    border: 1px solid var(--light-border-primary);
    border-top: none;
    align-items: center;
}

@media (max-width: 768px) {
    .line-item-light {
        grid-template-columns: 1fr;
        gap: 16px;
    }
}

.line-item-light:last-child {
    border-radius: 0 0 var(--light-radius-lg) var(--light-radius-lg);
}

.line-item-light input {
    width: 100%;
    padding: 10px 12px;
    font-size: 0.875rem;
    border: 1px solid var(--light-border-primary);
    border-radius: var(--light-radius-md);
    background: var(--light-bg-tertiary);
}

.line-item-light input:focus {
    outline: none;
    border-color: var(--light-primary);
    background: var(--light-bg-secondary);
}

.line-item-light .item-total {
    font-weight: 600;
    color: var(--light-text-primary);
    text-align: right;
}

.remove-item-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--light-danger-light);
    border: none;
    border-radius: var(--light-radius-md);
    color: var(--light-danger);
    cursor: pointer;
    transition: all 0.2s ease;
}

.remove-item-btn:hover {
    background: var(--light-danger);
    color: white;
}

.remove-item-btn svg {
    width: 18px;
    height: 18px;
}

.add-item-light-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    background: var(--light-bg-tertiary);
    border: 2px dashed var(--light-border-secondary);
    border-radius: var(--light-radius-lg);
    color: var(--light-text-secondary);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 16px;
}

.add-item-light-btn:hover {
    background: var(--light-primary-light);
    border-color: var(--light-primary);
    color: var(--light-primary);
}

.add-item-light-btn svg {
    width: 20px;
    height: 20px;
}

.invoice-totals-light {
    margin-top: 24px;
    padding: 24px;
    background: var(--light-bg-tertiary);
    border-radius: var(--light-radius-lg);
    max-width: 320px;
    margin-left: auto;
}

.totals-light-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    font-size: 0.9375rem;
}

.totals-light-row.total-row {
    border-top: 2px solid var(--light-border-primary);
    margin-top: 8px;
    padding-top: 16px;
    font-size: 1.125rem;
    font-weight: 700;
}

.form-actions-light {
    display: flex;
    justify-content: flex-end;
    gap: 16px;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--light-border-primary);
}

.back-light-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: var(--light-text-secondary);
    text-decoration: none;
    margin-bottom: 16px;
}

.back-light-link:hover {
    color: var(--light-primary);
}

.back-light-link svg {
    width: 16px;
    height: 16px;
}
</style>
{% endblock %}

{% block nav %}{% endblock %}
{% block footer %}{% endblock %}

{% block content %}
<div class="dashboard-light">
    {% include 'components/sidebar-light.html' with active='new_invoice' %}
    
    <main class="dashboard-light-main">
        <a href="{% url 'dashboard' %}" class="back-light-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
            </svg>
            Back to Dashboard
        </a>
        
        <header class="dashboard-light-header">
            <div class="dashboard-light-header-content">
                <h1>Create New Invoice</h1>
                <p>Fill in the details below to create a professional invoice</p>
            </div>
        </header>
        
        <form method="post" id="invoice-form">
            {% csrf_token %}
            <input type="hidden" name="line_items" id="line_items_data" value="[]">
            
            <div class="form-light-sections">
                <div class="section-light">
                    <div class="section-light-header">
                        <div class="section-light-icon icon-business">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <h2 class="section-light-title">Your Business</h2>
                    </div>
                    <div class="form-light-grid">
                        <div class="form-light-group full-width">
                            <label class="form-light-label">Business Name *</label>
                            <input type="text" name="business_name" class="form-light-input" required value="{{ invoice_form.business_name.value|default:'' }}">
                        </div>
                        <div class="form-light-group">
                            <label class="form-light-label">Business Email</label>
                            <input type="email" name="business_email" class="form-light-input" value="{{ invoice_form.business_email.value|default:'' }}">
                        </div>
                        <div class="form-light-group">
                            <label class="form-light-label">Phone Number</label>
                            <input type="text" name="business_phone" class="form-light-input" value="{{ invoice_form.business_phone.value|default:'' }}">
                        </div>
                        <div class="form-light-group full-width">
                            <label class="form-light-label">Address</label>
                            <textarea name="business_address" class="form-light-textarea" rows="2">{{ invoice_form.business_address.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
                
                <div class="section-light">
                    <div class="section-light-header">
                        <div class="section-light-icon icon-client">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <h2 class="section-light-title">Client Details</h2>
                    </div>
                    <div class="form-light-grid">
                        <div class="form-light-group full-width">
                            <label class="form-light-label">Client Name *</label>
                            <input type="text" name="client_name" class="form-light-input" required value="{{ invoice_form.client_name.value|default:'' }}">
                        </div>
                        <div class="form-light-group">
                            <label class="form-light-label">Client Email</label>
                            <input type="email" name="client_email" class="form-light-input" value="{{ invoice_form.client_email.value|default:'' }}">
                        </div>
                        <div class="form-light-group">
                            <label class="form-light-label">Client Phone</label>
                            <input type="text" name="client_phone" class="form-light-input" value="{{ invoice_form.client_phone.value|default:'' }}">
                        </div>
                        <div class="form-light-group full-width">
                            <label class="form-light-label">Client Address</label>
                            <textarea name="client_address" class="form-light-textarea" rows="2">{{ invoice_form.client_address.value|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-light">
                <div class="section-light-header">
                    <div class="section-light-icon icon-invoice">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                    </div>
                    <h2 class="section-light-title">Invoice Details</h2>
                </div>
                <div class="form-light-grid form-light-grid-3">
                    <div class="form-light-group">
                        <label class="form-light-label">Invoice Date *</label>
                        <input type="date" name="invoice_date" class="form-light-input" required value="{{ invoice_form.invoice_date.value|default:'' }}">
                    </div>
                    <div class="form-light-group">
                        <label class="form-light-label">Due Date *</label>
                        <input type="date" name="due_date" class="form-light-input" required value="{{ invoice_form.due_date.value|default:'' }}">
                    </div>
                    <div class="form-light-group">
                        <label class="form-light-label">Currency</label>
                        <select name="currency" class="form-light-select">
                            <option value="USD" {% if invoice_form.currency.value == 'USD' %}selected{% endif %}>USD ($)</option>
                            <option value="EUR" {% if invoice_form.currency.value == 'EUR' %}selected{% endif %}>EUR (&euro;)</option>
                            <option value="GBP" {% if invoice_form.currency.value == 'GBP' %}selected{% endif %}>GBP (&pound;)</option>
                            <option value="NGN" {% if invoice_form.currency.value == 'NGN' %}selected{% endif %}>NGN (&#8358;)</option>
                        </select>
                    </div>
                </div>
                <div class="form-light-grid" style="margin-top: 20px;">
                    <div class="form-light-group">
                        <label class="form-light-label">Tax Rate (%)</label>
                        <input type="number" name="tax_rate" id="tax_rate" class="form-light-input" step="0.01" min="0" max="100" value="{{ invoice_form.tax_rate.value|default:'0' }}">
                    </div>
                    <div class="form-light-group">
                        <label class="form-light-label">Notes</label>
                        <textarea name="notes" class="form-light-textarea" rows="2" placeholder="Payment terms, bank details, etc.">{{ invoice_form.notes.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>
            
            <div class="section-light">
                <div class="section-light-header">
                    <div class="section-light-icon icon-items">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="8" y1="6" x2="21" y2="6"/>
                            <line x1="8" y1="12" x2="21" y2="12"/>
                            <line x1="8" y1="18" x2="21" y2="18"/>
                            <line x1="3" y1="6" x2="3.01" y2="6"/>
                            <line x1="3" y1="12" x2="3.01" y2="12"/>
                            <line x1="3" y1="18" x2="3.01" y2="18"/>
                        </svg>
                    </div>
                    <h2 class="section-light-title">Line Items</h2>
                </div>
                
                <div class="line-items-light">
                    <div class="line-items-light-header">
                        <span>Description</span>
                        <span>Qty</span>
                        <span>Unit Price</span>
                        <span>Total</span>
                        <span></span>
                    </div>
                    <div id="line-items-list"></div>
                    <button type="button" id="add-line-item" class="add-item-light-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                        Add Line Item
                    </button>
                </div>
                
                <div class="invoice-totals-light">
                    <div class="totals-light-row">
                        <span>Subtotal</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="totals-light-row">
                        <span>Tax (<span id="tax-rate-display">0</span>%)</span>
                        <span id="tax-amount">$0.00</span>
                    </div>
                    <div class="totals-light-row total-row">
                        <span>Total</span>
                        <span id="grand-total">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="form-actions-light">
                <a href="{% url 'dashboard' %}" class="btn-light-secondary">Cancel</a>
                <button type="submit" class="btn-light-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="12" y1="11" x2="12" y2="17"/>
                        <line x1="9" y1="14" x2="15" y2="14"/>
                    </svg>
                    Create Invoice
                </button>
            </div>
        </form>
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ request.csp_nonce }}">
document.addEventListener('DOMContentLoaded', function() {
    const mobileToggle = document.getElementById('mobile-toggle');
    const sidebar = document.getElementById('dashboard-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (mobileToggle) {
        mobileToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        });
    }
    
    if (overlay) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        });
    }
    
    let lineItems = [];
    let itemId = 0;
    
    const lineItemsList = document.getElementById('line-items-list');
    const addItemBtn = document.getElementById('add-line-item');
    const lineItemsData = document.getElementById('line_items_data');
    const taxRateInput = document.getElementById('tax_rate');
    
    function formatCurrency(amount) {
        return '$' + parseFloat(amount || 0).toFixed(2);
    }
    
    function createLineItem(id) {
        const div = document.createElement('div');
        div.className = 'line-item-light';
        div.dataset.id = id;
        div.innerHTML = `
            <input type="text" placeholder="Item description" class="item-description" required>
            <input type="number" placeholder="1" value="1" min="1" class="item-quantity">
            <input type="number" placeholder="0.00" step="0.01" min="0" class="item-price">
            <span class="item-total">$0.00</span>
            <button type="button" class="remove-item-btn" onclick="removeItem(${id})">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        `;
        
        const inputs = div.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                updateItemTotal(div);
                updateTotals();
            });
        });
        
        return div;
    }
    
    function updateItemTotal(itemDiv) {
        const qty = parseFloat(itemDiv.querySelector('.item-quantity').value) || 0;
        const price = parseFloat(itemDiv.querySelector('.item-price').value) || 0;
        const total = qty * price;
        itemDiv.querySelector('.item-total').textContent = formatCurrency(total);
    }
    
    function updateTotals() {
        let subtotal = 0;
        const items = lineItemsList.querySelectorAll('.line-item-light');
        
        items.forEach(item => {
            const qty = parseFloat(item.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(item.querySelector('.item-price').value) || 0;
            subtotal += qty * price;
        });
        
        const taxRate = parseFloat(taxRateInput.value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;
        
        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('tax-rate-display').textContent = taxRate;
        document.getElementById('tax-amount').textContent = formatCurrency(taxAmount);
        document.getElementById('grand-total').textContent = formatCurrency(total);
        
        saveLineItems();
    }
    
    function saveLineItems() {
        const items = [];
        const itemDivs = lineItemsList.querySelectorAll('.line-item-light');
        
        itemDivs.forEach(div => {
            const description = div.querySelector('.item-description').value;
            const quantity = parseFloat(div.querySelector('.item-quantity').value) || 0;
            const price = parseFloat(div.querySelector('.item-price').value) || 0;
            
            if (description && quantity > 0) {
                items.push({ description, quantity, unit_price: price });
            }
        });
        
        lineItemsData.value = JSON.stringify(items);
    }
    
    window.removeItem = function(id) {
        const item = lineItemsList.querySelector(`[data-id="${id}"]`);
        if (item) {
            item.remove();
            updateTotals();
        }
    };
    
    addItemBtn.addEventListener('click', function() {
        const item = createLineItem(itemId++);
        lineItemsList.appendChild(item);
    });
    
    taxRateInput.addEventListener('input', updateTotals);
    
    addItemBtn.click();
});
</script>
{% endblock %}
